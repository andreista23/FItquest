﻿@using FitQuest.Data
@using Microsoft.EntityFrameworkCore
@using System.Security.Claims
@inject ApplicationDbContext Db

@{
    var userIdString = User.FindFirstValue(ClaimTypes.NameIdentifier);
    int.TryParse(userIdString, out int userId);

    var unread = userId == 0 ? 0 : await Db.Notifications.CountAsync(n => n.UserId == userId && !n.IsRead);
    var last = userId == 0
        ? new List<FitQuest.Models.Notification>()
        : await Db.Notifications
            .Where(n => n.UserId == userId)
            .OrderByDescending(n => n.CreatedAt)
            .Take(30)
            .ToListAsync();
}

<li class="nav-item dropdown me-3">
    <a class="nav-link position-relative" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
        🔔
        @if (unread > 0)
        {
            <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">
                @unread
            </span>
        }
    </a>

    <ul class="dropdown-menu dropdown-menu-end p-0 shadow notifications-dropdown">
        <li class="px-3 py-2 border-bottom d-flex justify-content-between align-items-center">
            <span class="fw-semibold">Notifications</span>
            <form method="post" asp-page="/Notifications/Clear" class="m-0">
                <button type="submit" class="btn btn-sm btn-outline-danger">
                    Clear
                </button>
            </form>
        </li>

        <li class="notifications-list">
            @if (last.Count > 0)
            {
                @foreach (var n in last)
                {
                    <div class="px-3 py-2 small border-bottom">
                        @n.Message
                        <div class="text-muted" style="font-size: 0.75rem;">
                            @n.CreatedAt.ToLocalTime().ToString("dd MMM yyyy, HH:mm")
                        </div>
                    </div>
                }
            }
            else
            {
                <div class="px-3 py-3 small text-muted">
                    No notifications yet.
                </div>
            }
        </li>
    </ul>

</li>